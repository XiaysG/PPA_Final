---
title: "Measuring Gentrification - A Study in Boston"
author: "Xiayuanshan Gao"
date: "2024-05-07"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    number_sections: yes
    theme: cosmo 
    highlight: tango    
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(sf)
library(spdep)
library(caret)
library(ckanr)
library(FNN)
library(grid)
library(gridExtra)
library(ggcorrplot) # plot correlation plot
library(corrr)      # another way to plot correlation plot
library(kableExtra)
library(jtools)     # for regression model plots
library(ggstance) # to support jtools plots
library(ggpubr)    # plotting R^2 value on ggplot point scatter
library(broom.mixed) # needed for effects plots
library(RColorBrewer)
library(RSocrata)

library(RSocrata)
library(viridis)
library(spatstat)
library(spdep)
library(FNN)
library(knitr)
library(kableExtra)
library(tidycensus)

root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

palette5 <- c("#7892B5","#8CB9C0","#91B5A9","#EDCA7F","#D98481")
palette4 <- c("#7892B5","#8CB9C0","#EDCA7F","#D98481")
palette2 <- c("#7892B5","#D98481")

```

# Intro


# Data Collection




## Spatial Data

## Metro Stations


```{r}
# Reading neighborhood boundaries GeoJSON from the raw GitHub URL and transforming CRS
boundary <- st_read("CityBoundaryofLosAngeles.geojson")%>%
st_transform('ESRI:102645')

metro <- 
  st_read("data/Metro_Stations.geojson")%>%
  st_transform('ESRI:102645')
```

### Grocery store
```{r}
grocerystore <- read.socrata("https://data.lacity.org/resource/g986-7yf9.json")

# Clean and process the data
grocerystore <- grocerystore %>%
  dplyr::select(location_1.latitude, location_1.longitude) %>%
  na.omit() %>%
  st_as_sf(coords = c("location_1.longitude", "location_1.latitude"), crs = 4326, agr = "constant")%>%
 st_transform('ESRI:102645')
```



### Restaurant
```{r}
restaurant <- read.socrata("https://data.lacity.org/resource/ieer-tbdq.json")

restaurant <- restaurant %>%
  dplyr::select(Y = location_1.latitude, X = location_1.longitude) %>%
  na.omit() %>%
  st_as_sf(coords = c("X", "Y"), crs = 4326, agr = "constant") %>% # Transforming to the specified CRS
st_transform('ESRI:102645')

```

### educationfacities
```{r}
educationfacilities <- 
 st_read("https://services.arcgis.com/RmCCgQtiZLDCtblq/arcgis/rest/services/Schools_Colleges_and_Universities/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson") 

educationfacilities <- educationfacilities %>%
dplyr::select(Y = latitude, X = longitude) %>%
  na.omit() %>%
  st_as_sf(coords = c("X", "Y"), crs = 4326, agr = "constant")%>%  # Transforming to the specified CRS
  st_transform('ESRI:102645')
```

```{r}
# income restricted housing by neighborhood

inc_restricted_housing_2022 <- read.csv("https://data.boston.gov/dataset/feddfe5a-df16-4c60-8a3c-640c4d5281cd/resource/bfdeffc7-ab5e-4e28-9561-d4e84c9674e4/download/income-restricted-housing-inventory-2022.csv", stringsAsFactors = FALSE)

inc_restricted_housing_2018 <- read.csv("https://data.boston.gov/dataset/feddfe5a-df16-4c60-8a3c-640c4d5281cd/resource/47d53d7c-25b7-40b4-9259-da1d15373be6/download/income-restricted-inventory-2018-all-income-restricted-projects.csv", stringsAsFactors = FALSE)

```



```{r}
crime2015 <- 
  read.socrata("https://data.lacity.org/Public-Safety/Crime-Data-from-2010-to-2019/63jg-8b9z/") %>%
  mutate(year = substr(date_rptd,1,4)) %>% filter(year == "2015") %>%
  dplyr::select(Y = lat, X = lon) %>%
  na.omit() %>%
  st_as_sf(coords = c("X", "Y"), crs = 4326, agr = "constant") %>%
  st_transform('ESRI:102645')
  
```

```{r}
crime2020 <- 
  read.socrata("https://data.lacity.org/Public-Safety/Crime-Data-from-2020-to-Present/2nrs-mtv8/") %>%
  mutate(year = substr(date_rptd,1,4)) %>% filter(year == "2020") %>%
  dplyr::select(Y = lat, X = lon) %>%
  na.omit() %>%
  st_as_sf(coords = c("X", "Y"), crs = 4326, agr = "constant") %>%
  st_transform('ESRI:102645')
  
```


## Census Data 2015 and 2020

```{r}

census_api_key("f681592f0e7bc7e399e41102649c493ec7f7f574") 

variables <- c("B01001_001E",
  "B01001_002E",
  "B01001_026E",
   "B01001_007E",
  "B01001_012E",
   "B01001_016E",
 "B01001_020E","B02001_002E","B02001_003E", "B03001_003E", "B02001_004E", "B19001_002E","B19001_003E", "B19001_006E", "B19001_008E",
"B19001_010E", "B19001_012E","B07001_001E","B07001_017E","B07001_033E",
"B07001_049E",
"B07001_065E",
  "B15001_002E",
 "B15001_003E",
"B15001_005E",
"B15001_009E",
"B15001_010E",
   "B25001_001E",
  "B06012_002E",
  "B25002_003E",
"B25006_002E",
  "B25006_001E",
  "B19013_001E",
"B25077_001E",
"B25031_001",
"B08133_001"
)



# Fetch the data for LA, LA County, CA,2015
acs_la <- get_acs(
  geography = "tract",
  variables = variables,
  year = 2015,
  state = "06",
  county = "037",
  geometry = TRUE,
  survey = "acs5",
  output = "wide"
)%>%
st_transform('ESRI:102645')



# Fetch the data for LA, LA County, CA,2020
acs_la20 <- get_acs(
  geography = "tract",
  variables = variables,
  year = 2020,
  state = "06",
  county = "037",
  geometry = TRUE,
  survey = "acs5",
  output = "wide"
)%>%
  st_transform('ESRI:102645')
vars <- load_variables(2020, "acs5", cache = TRUE)

```


```{r}

acs_la <- acs_la %>%
  rename(
    totalPop = B01001_001E,
    male = B01001_002E,
    female = B01001_026E,
    age_18_24 = B01001_007E,
    age_25_44 = B01001_012E,
    age_45_64 = B01001_016E,
    age_65plus = B01001_020E,
    white = B02001_002E,
    popblack = B02001_003E,
    latino = B03001_003E,
    other_race = B02001_004E,
    income_less_20k = B19001_002E,
    income_20k_40k = B19001_003E,
    income_40k_60k = B19001_006E,
    income_60k_80k = B19001_008E,
    income_80k_100k = B19001_010E,
    income_more_100k = B19001_012E,
    migration_total = B07001_001E,
    migration_within_county = B07001_017E,
    migration_different_county_same_state = B07001_033E,
    migration_different_state = B07001_049E,
    migration_from_abroad = B07001_065E,
    edu_less_high_school = B15001_002E,
    edu_high_school_grad = B15001_003E,
    edu_some_college = B15001_005E,
    edu_bachelors = B15001_009E,
    edu_grad_professional = B15001_010E,
    total_housing_units = B25001_001E,
    total_poverty = B06012_002E,
    vacant_units = B25002_003E,
    white_houseOwner = B25006_002E,
    total_occupied_units = B25006_001E,
    median_HH_income = B19013_001E,
    houseprice = B25077_001E,
    rent = B25031_001E,
    travetimetowork = B08133_001E
  ) %>%
  select(-starts_with("B"),-NAME) %>%
  mutate(
    WhiteHOrate = white_houseOwner / total_occupied_units,
    pctBachelors = ifelse(totalPop > 0, (edu_bachelors + edu_grad_professional) / totalPop, 0),
    pctPoverty = ifelse(totalPop > 0, total_poverty / totalPop, 0),
    pctWhitePop = ifelse(totalPop > 0, white / totalPop, 0),
    pctLatinoPop = ifelse(totalPop > 0, latino / totalPop, 0),
    pctBlackPop = ifelse(totalPop > 0, popblack / totalPop, 0),
    pctMigration = ifelse(totalPop > 0, migration_total / totalPop, 0),
    pctForeignMig = ifelse(totalPop > 0, migration_from_abroad / totalPop, 0),
    pct2540 = ifelse(totalPop > 0,  age_25_44 / totalPop, 0),
    landArea = st_area(geometry), 
    popDensity = totalPop / as.numeric(landArea)
  )

```

```{r}
acs_la20 <- acs_la20 %>%
  rename(totalPop20 = "B01001_001E",
  male20 = "B01001_002E",
  female20 = "B01001_026E",
  age_18_2420 = "B01001_007E",
  age_25_4420 = "B01001_012E",
  age_45_6420 = "B01001_016E",
  age_65plus20 = "B01001_020E",
  white20 = "B02001_002E",
  popblack20 = "B02001_003E",
  latino20 = "B03001_003E",
  other_race20 = "B02001_004E",
  income_less_20k20 = "B19001_002E",
  income_20k_40k20 = "B19001_003E",
  income_40k_60k20 = "B19001_006E",
  income_60k_80k20 = "B19001_008E",
  income_80k_100k20 = "B19001_010E",
  income_more_100k20 = "B19001_012E",
  migration_total20 = "B07001_001E",
  migration_within_county20 = "B07001_017E",
  migration_different_county_same_state20 = "B07001_033E",
  migration_different_state20 = "B07001_049E",
  migration_from_abroad20 = "B07001_065E",
  edu_less_high_school20 = "B15001_002E",
  edu_high_school_grad20 = "B15001_003E",
  edu_some_college20 = "B15001_005E",
  edu_bachelors20 = "B15001_009E",
  edu_grad_professional20 = "B15001_010E",
  total_housing_units20 = "B25001_001E",
  total_poverty20 = "B06012_002E",
  vacant_units20 = "B25002_003E",
  white_houseOwner20 = "B25006_002E",
  total_Ooccupied_Uunits20 = "B25006_001E",
  median_HH_income20 = "B19013_001E",
  houseprice20 = "B25077_001E",
  rent20="B25031_001E"
)%>%
  dplyr::select(-starts_with("B")) %>% 
  mutate(WhiteHOrate20 = white_houseOwner20/total_Ooccupied_Uunits20,
         pctBachelors20 = ifelse(totalPop20 > 0, ((edu_bachelors20 + edu_grad_professional20) / totalPop20),0),
         pctPoverty20 = ifelse(totalPop20 > 0, total_poverty20 / totalPop20, 0),
         pctWhitePop20 = ifelse(totalPop20 > 0, white20 / totalPop20, 0),
         pctLatinoPop20 = ifelse(totalPop20 > 0, latino20 / totalPop20, 0),
         pctBlackPop20 = ifelse(totalPop20 > 0, popblack20 / totalPop20, 0),
         pctMigration20 = ifelse(totalPop20 > 0, migration_total20 / totalPop20, 0),
         pctForeignMig20 = ifelse(totalPop20 > 0, migration_from_abroad20 / totalPop20, 0),
         pct254020 = ifelse(totalPop20 > 0,  age_25_4420 / totalPop20, 0),
         landArea20 = st_area(geometry), 
         popDensity20 = totalPop20 / as.numeric(landArea20))
```






# Measuring Gentrification

```{r cars}

library(tidycensus)
library(dplyr)
library(sf)
library(ggplot2)


# labor force: B16010_041
# empolymentL:B23006_023
# Define variables for ACS data retrieval

variable <- c(med_income = "B19013_001E",  # Median household income
               total_bachelors = "B16010_041E",  # with Bachelor's degree or higher
               med_home_value = "B25077_001E")  # Median home value

# variables_2009 <- c(med_income = "B19013_001E",  # Median household income
#                # % with Bachelor's degree or higher
#                med_home_value = "B25077_001E",
#                whitealone_male = 'C15002H_006E',
#                whitealone_female = 'C15002H_011E',
#                black_male = 'C15002B_006E',
#                black_female = 'C15002B_011E',
#                Indian_male = 'C15002C_006E',
#                Indian_female = 'C15002C_011E',
#                Asian_male = 'C15002D_006E',
#                Asian_female = 'C15002D_011E',
#                Hawaiian_male = 'C15002E_006E',
#                Hawaiian_female = 'C15002E_011E',
#                other_male = 'C15002F_006E',
#                other_female = 'C15002F_011E',
#                two_male = 'C15002G_006E',
#                two_female = 'C15002G_011E',
#                hispanic_male = 'C15002I_006E',
#                hispanic_female = 'C15002I_011E'
#                ) 



# Fetch ACS data for 2010 and 2015
acs2014 <- get_acs(geography = "tract", variables = variable, year = 2014, 
                   survey = "acs5", state = 06, county = 037, geometry = TRUE,output = "wide") 
# %>% 
#   select(-matches("M$")) %>% 
#   mutate(total_bachelors = whitealone_male + whitealone_female +
#                             black_male + black_female +
#                             Indian_male + Indian_female +
#                             Asian_male + Asian_female +
#                             Hawaiian_male + Hawaiian_female +
#                             other_male + other_female +
#                             two_male + two_female +
#                             hispanic_male + hispanic_female) %>%
#   select(
#     -whitealone_male, -whitealone_female,
#     -black_male, -black_female,
#     -Indian_male, -Indian_female,
#     -Asian_male, -Asian_female,
#     -Hawaiian_male, -Hawaiian_female,
#     -other_male, -other_female,
#     -two_male, -two_female,
#     -hispanic_male, -hispanic_female
#   )
  

acs2020 <- get_acs(geography = "tract", variables = variable, year = 2020, 
                   survey = "acs5", state = 06, county = 037, geometry = TRUE,output = "wide") %>% 
  select(-matches("M$"))%>% 
st_transform('ESRI:102645')

acs2015 <- get_acs(geography = "tract", variables = variable, year = 2015, 
                   survey = "acs5", state = 06, county = 037, geometry = TRUE,output = "wide") %>% 
  select(-matches("M$"))%>% 
st_transform('ESRI:102645')


# Drop geometry for joining data on attributes
acs2014_nogeom <- st_drop_geometry(acs2014)
acs2020_nogeom <- st_drop_geometry(acs2020)
acs2015_nogeom <- st_drop_geometry(acs2015)

acs2014_nogeom <- acs2014_nogeom %>%
  rename_with(~paste0(., ".2014"), matches("^med_income|^total_bachelors|^med_home_value"))

acs2020_nogeom <- acs2020_nogeom %>%
  rename_with(~paste0(., ".2020"), matches("^med_income|^total_bachelors|^med_home_value"))
acs2015_nogeom <- acs2015_nogeom %>%
  rename_with(~paste0(., ".2015"), matches("^med_income|^total_bachelors|^med_home_value"))

gentrified_data <- left_join(acs2014_nogeom, acs2020_nogeom, by = "GEOID") %>%
  left_join(acs2015_nogeom, by = "GEOID")
gentrified_data <- gentrified_data %>%
  mutate(
    income_change_2020_2015 = (`med_income.2020` - `med_income.2015`) / `med_income.2015` * 100,
    education_change_2020_2015 = (`total_bachelors.2020` - `total_bachelors.2015`) / `total_bachelors.2015` * 100,
    home_value_change_2020_2015 = (`med_home_value.2020` - `med_home_value.2015`) / `med_home_value.2015` * 100,) %>% 
  select(-matches("^NAME"))
   
# Convert it back
gentrified_data_sf <- st_as_sf(gentrified_data, geometry = st_geometry(acs2014), crs = st_crs(acs2014))

```



``` {r testing}

# Assuming data_sf is already loaded and contains the necessary columns

# Calculate thresholds for 2009
thresholds_2014 <- gentrified_data_sf %>%
  summarise(
    threshold_home_value_2014 = quantile(med_home_value.2014, 0.4, na.rm = TRUE),
    threshold_income_2014 = quantile(med_income.2014, 0.4, na.rm = TRUE)
  )

# Convert thresholds to a simpler format if needed (depending on the context)
thresholds_2014 <- as.data.frame(thresholds_2014)

# Define eligibility in 2009 based on population, home value, and income
eligible_tracts <- gentrified_data_sf %>%
  filter(#population.2009 > 500,
         med_home_value.2014 < thresholds_2014$threshold_home_value_2014,
         med_income.2014 < thresholds_2014$threshold_income_2014)

# Calculate changes from 2010 to 2015
changes_2020_2015 <- eligible_tracts %>%
  mutate(
    home_value_change = med_home_value.2020 - med_home_value.2015,
    income_change = med_income.2020 - med_income.2015,
    education_change = total_bachelors.2020 - total_bachelors.2015
  )

# Calculate 60th percentile changes as new thresholds for changes
thresholds_2015 <- changes_2020_2015 %>%
  summarise(
    top_40th_home_value_change = quantile(home_value_change, 0.4, na.rm = TRUE),
    top_40th_income_change = quantile(income_change, 0.4, na.rm = TRUE),
    top_40th_education_change = quantile(education_change, 0.4, na.rm = TRUE)
  )

# Convert to a simpler format
thresholds_2015 <- as.data.frame(thresholds_2015)

# Apply change criteria for 2010-2015
gentrified_tracts <- changes_2020_2015 %>%
  filter(home_value_change > thresholds_2015$top_40th_home_value_change,
         #home_value_change >0,
         income_change > thresholds_2015$top_40th_income_change,
         education_change > thresholds_2015$top_40th_education_change)


gentrified_tracts <- gentrified_tracts %>%
  dplyr::select(GEOID,geometry)

gentrified_tractsnew <- st_drop_geometry(gentrified_tracts)%>%
   mutate(gentrification = 1)

# Mapping the results
ggplot(gentrified_tracts) +
  geom_sf(fill = "blue", color = "black") +
  labs(title = "Gentrified Areas in 2020",
       subtitle = "Tracts meeting all criteria for significant changes") +
  theme_minimal()


# Switch to your own path, Xia and Jiahang!
#la_city_boundary <- st_read("CityBoundaryofLosAngeles.geojson") %>%
#st_transform(st_crs(gentrified_tracts))


# THIS IS THE DATASET!!!!!!!!!
#gentrified_tracts_LA <- st_intersection(gentrified_tracts, la_city_boundary)

# Need Spatial Join by geometry or join by GEOID
```



# Feature Engineering

## identify change in census

```{r}
library(sf)
library(dplyr)

# Drop geometry from acs_la and acs_la20 and join them
acs_la_nogeom <- st_drop_geometry(acs_la)
acs_la20_nogeom <- st_drop_geometry(acs_la20)
data <- left_join(acs_la_nogeom, acs_la20_nogeom, by = "GEOID")


# Convert acs2015 to a spatial dataframe and select relevant columns
datageography <- st_as_sf(acs2015, geometry = "geometry", crs = 4326) %>%
  select(GEOID, geometry)

# Joining non-spatial data with spatial data and ensuring it remains a spatial dataframe
datanew <- left_join(data, datageography, by = "GEOID")
datanew <- st_as_sf(datanew, geometry = st_geometry(acs_la), crs = st_crs(acs_la))

# Read and transform the boundary to match LA's local projection
boundary <- st_read("CityBoundaryofLosAngeles.geojson") %>%
  st_transform(crs = 'ESRI:102645')

# Transform datanew to match the CRS of boundary
datanew <- st_transform(datanew, st_crs(boundary))

# Perform the intersection of boundary and datanew
tractclipped <- st_intersection(boundary, datanew)

# Select GEOID and geometry from the intersection result
tractgeography <- tractclipped %>%
  select(GEOID, geometry)

# Correcting the assignment and ensuring proper use of the pipe operator
tractclippednew <- tractclipped %>%
  left_join(gentrified_tractsnew[, c("GEOID", "gentrification")], by = "GEOID")

# Assuming your dataframe is called 'data'
tractclippednew <- tractclippednew %>%
  mutate(gentrification = replace_na(gentrification, 0))

```

```{r}
tractclippednew <- tractclippednew  %>%
  mutate(changeinpoverty = pctPoverty20 - pctPoverty,
         changeinbachelor = pctBachelors20 - pctBachelors,
         changeinwhite = pctWhitePop20 - pctWhitePop,
         changeinhouseprice=houseprice20-houseprice,
         changeinrent=rent20-rent,
         changein2544= pct254020- pct2540)
```


## identify number of grocery stores in each tract

```{r}

grocerystorepoint <- grocerystore %>%
  st_transform(st_crs(tractgeography))%>%
  st_join(tractgeography, left = F)
  
grocerystorenumber <- grocerystorepoint %>%
  group_by(GEOID) %>% 
  summarise(grocerycount = n())
  
grocerystorenumber <- grocerystorenumber
grocerystorenumber <- st_set_geometry(grocerystorenumber, NULL)

gentrifydata <- left_join(tractclippednew, grocerystorenumber )
```

## identify number of new housing permit in each tract


```{r}

newhousingpermitpoint <- newhousingpermit %>%
  st_join(tractgeography, left = F)
newhousingpermitnumber <- newhousingpermitpoint %>%
  group_by(GEOID) %>% 
  summarise(newhousingpermitcount = n())
  
newhousingpermitnumber <- newhousingpermitnumber
newhousingpermitnumber <- st_set_geometry(newhousingpermitnumber, NULL)

gentrifydata <- left_join(gentrifydata, newhousingpermitnumber )
```


## identify number of restaurants in each tract


```{r}

restaurantpoint <- restaurant %>%
  st_join(tractgeography, left = F)
restaurantnumber <- restaurantpoint %>%
  group_by(GEOID) %>%  
  summarise(restaurantcount = n())
  
restaurantnumber <- restaurantnumber
restaurantnumber <- st_set_geometry(restaurantnumber, NULL)

gentrifydata <- left_join(gentrifydata, restaurantnumber )

```

## identify number of education facilities in each tract

```{r}

educationfacilitiespoint <- educationfacilities %>%
  st_join(tractgeography, left = F)
educationfacilitiesnumber <- educationfacilitiespoint %>%
  group_by(GEOID) %>%  
  summarise(educationfacilitiescount = n())
  
educationfacilitiesnumber <- educationfacilitiesnumber
educationfacilitiesnumber <- st_set_geometry(educationfacilitiesnumber, NULL)


```


## Visualizing amenity patterns


```{r}
library(ggplot2)
library(patchwork)


plot_school <- ggplot() +
  geom_sf(data=gentrifydata,fill="transparent", color = "grey")+
  stat_density2d(data = data.frame(st_coordinates(educationfacilitiespoint)), 
                 aes(X, Y, fill = ..level.., alpha = ..level..),
                 size = 0.01, bins = 40, geom = 'polygon') +
  scale_fill_gradient(low='#7892B5', high='#fecc5c', name = "Density") +
  scale_alpha(range = c(0.00, 0.35), guide = FALSE) +
  labs(title="Density of education facilities")+
   theme_void()



plot_grocerystores <- ggplot() +
  geom_sf(data=gentrifydata,fill="transparent", color = "grey")+
  stat_density2d(data = data.frame(st_coordinates(grocerystorepoint)), 
                 aes(X, Y, fill = ..level.., alpha = ..level..),
                 size = 0.01, bins = 40, geom = 'polygon') +
  scale_fill_gradient(low='#7892B5', high='#fecc5c', name = "Density") +
  scale_alpha(range = c(0.00, 0.35), guide = FALSE) +
  labs(title="Density of Grocery Stores")+
   theme_void()



plot_housingpermit <- ggplot() +
  geom_sf(data=gentrifydata,fill="transparent", color = "grey")+
  stat_density2d(data = data.frame(st_coordinates(newhousingpermitpoint)), 
                 aes(X, Y, fill = ..level.., alpha = ..level..),
                 size = 0.01, bins = 40, geom = 'polygon') +
  scale_fill_gradient(low='#7892B5', high='#fecc5c', name = "Density") +
  scale_alpha(range = c(0.00, 0.35), guide = FALSE) +
  labs(title="Density of housingpermit",subtitle = "Los Angelas,CA")+
   theme_void()




plot_restaurant<- ggplot() +
  geom_sf(data=gentrifydata,fill="transparent", color = "grey")+
  stat_density2d(data = data.frame(st_coordinates(restaurantpoint)), 
                 aes(X, Y, fill = ..level.., alpha = ..level..),
                 size = 0.01, bins = 40, geom = 'polygon') +
  scale_fill_gradient(low='#7892B5', high='#fecc5c', name = "Density") +
  scale_alpha(range = c(0.00, 0.35), guide = FALSE) +
  labs(title="Density of Restaurants",subtitle = "Los Angelas, CA")+
   theme_void()


wrap_plots(
  plot_restaurant, plot_school, plot_housingpermit, plot_grocerystores,
  ncol = 2  
)

```


## Defining TOD Area (Buffer, Union, and Centroid Selection)

In the following steps, I buffered half-mile from the metro stations and bus stations, and select the census tracts containing the centroids of the buffers. These selected census tracts are defined as TOD area as dummy variable compared to non-TOD area
```{r Metro Buffer, warning = FALSE, cache = TRUE, message = FALSE}
metroBuffer <- st_buffer(metro, 2640) 

metroUnion <- st_union(metroBuffer)

```


```{r union and transformer, warning = FALSE, cache = TRUE, message = FALSE}

metroUnion <- st_transform(metroUnion, crs = st_crs(tractgeography))
```

```{r plot intersection, warning = FALSE, cache = TRUE, message = FALSE}
selectCentroids <- st_centroid(tractgeography)

intersection <- st_intersects(tractgeography, metroUnion, sparse = FALSE)

tractgeography <- tractgeography %>%
  mutate(intersection = purrr::map_dbl(intersection, ~ ifelse(any(.x), 1, 0)))

intersection_data <- tractgeography %>%
  select(GEOID, intersection)
```

```{r}
gentrifydata <- st_join(gentrifydata, intersection_data, by = "GEOID")
```

## Crime by Tract

```{r}
crime2015point <- crime2015 %>%
  st_join(tractgeography, left = F)
crime2015number <- crime2015point %>%
  group_by(GEOID) %>%  
  summarise(crime2015count = n())
  
crime2015number <- crime2015number
crime2015number <- st_set_geometry(crime2015number, NULL)

gentrifydata <- left_join(gentrifydata, crime2015number, by = c("GEOID.x" = "GEOID"))
```

```{r}
crime2020point <- crime2020 %>%
  st_join(tractgeography, left = F)
crime2020number <- crime2020point %>%
  group_by(GEOID) %>%  # Replace TRACT_ID with the actual identifier field for tracts
  summarise(crime2020count = n())
  
crime2020number <- crime2020number
crime2020number <- st_set_geometry(crime2020number, NULL)

gentrifydata <- left_join(gentrifydata,crime2020number, by = c("GEOID.x" = "GEOID"))
```

```{r}
gentrifydata <- gentrifydata %>%
  mutate(crimeChange = crime2020count - crime2015count)

```

```{r}
plot_crime2015 <- ggplot() +
  geom_sf(data = gentrifydata, fill = "transparent", color = "grey") +
  stat_density2d(data = gentrifydata, 
                 aes(X, Y, fill = ..level.., alpha = ..level..), 
                 size = 0.01, bins = 40, geom = 'polygon') +
  scale_fill_gradient(low = "#7892B5", high = "#fecc5c", name = "Density") +
  scale_alpha(range = c(0.00, 0.35), guide = FALSE) +
  labs(title = "Density of Crime in 2015", subtitle = "Los Angeles, CA") +
  theme_void()

plot_crime2020 <- ggplot() +
  geom_sf(data = gentrifydata, fill = "transparent", color = "grey") +
  stat_density2d(data = gentrifydata, 
                 aes(X, Y, fill = ..level.., alpha = ..level..), 
                 size = 0.01, bins = 40, geom = 'polygon') +
  scale_fill_gradient(low = "#7892B5", high = "#fecc5c", name = "Density") +
  scale_alpha(range = c(0.00, 0.35), guide = FALSE) +
  labs(title = "Density of Crime in 2020", subtitle = "Los Angeles, CA") +
  theme_void()

crime_plots <- plot_crime2015 + plot_crime2020 + 
                  plot_layout(ncol = 2)  # Arrange the plots in 2 columns

# Print the combined plot
print(combined_plots)


```

```{r}
plot_crime2015 <- ggplot(data = gentrifydata, aes(fill = crime2015count)) +
  geom_sf() +
  scale_fill_viridis_c(option = "plasma", name = "Crime Count 2015") +
  labs(title = "Density of Crime in 2015", subtitle = "Los Angeles, CA") +
  theme_void() +
  theme(legend.position = "bottom")

plot_crime2020 <- ggplot(data = gentrifydata, aes(fill = crime2020count)) +
  geom_sf() +
  scale_fill_viridis_c(option = "plasma", name = "Crime Count 2020") +
  labs(title = "Density of Crime in 2020", subtitle = "Los Angeles, CA") +
  theme_void() +
  theme(legend.position = "bottom")

crime_plots <- plot_crime2015 + plot_crime2020 + 
                  plot_layout(ncol = 2)  # Arrange the plots in 2 columns

# Print the combined plot
print(crime_plots)

ggsave("crime.png", plot = crime_plots, bg = "transparent", width = 10, height = 8, dpi = 300)

```


# Logistic regression
```{r}
colnames(gentrifydata)
```
## Modeling building






```{r}

gentrifydata <- st_set_geometry(gentrifydata, NULL)
# Replace NA values in the 'gentrification' column with 0 (or another appropriate value)
set.seed(479)
trainIndex <- createDataPartition(y = paste(gentrifydata) , p = .65,
                                  list = FALSE,
                                  times = 1)
```



```{r}
gentrifydataTrain <- gentrifydata[ trainIndex,]
gentrifydataTest  <- gentrifydata[-trainIndex,]

gentrifyModel <- glm(gentrification ~ .,data=gentrifydataTrain %>% dplyr::select(gentrification, changeinpoverty,changeinbachelor, changeinwhite,pctBachelors20,pctBachelors,houseprice,changein2544,houseprice20,rent,rent20,total_housing_units,total_housing_units20),family="binomial"(link="logit"))

# Load necessary libraries
library(dplyr)
library(knitr)
library(kableExtra)

# Assuming recidivismModel and previous steps have been correctly run
gentrifyModel_sum <- summary(gentrifyModel)
coefficients_table <- as.data.frame(gentrifyModel_sum $coefficients)

# Apply significance stars based on p-values
coefficients_table$significance <- ifelse(coefficients_table$`Pr(>|z|)` < 0.001, '***',
                                         ifelse(coefficients_table$`Pr(>|z|)` < 0.01, '**',
                                                ifelse(coefficients_table$`Pr(>|z|)` < 0.05, '*',
                                                       ifelse(coefficients_table$`Pr(>|z|)` < 0.1, '.', ''))))



# Print the table with formatting
kable(coefficients_table %>% select(-significance, -`Pr(>|z|)`), align = "r") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  footnote(general_title = "\n", general = "Table 3")
summary(gentrifyModel)
```

```{r}
library(pscl)
library(plotROC)
library(pROC)
pR2(gentrifyModel ) #McFadden: 0.246
```

Visually we now can begin comparing the predictions of recidivism. A negative or 0 value means that there is no recidivism, while a positive or 1 value means that there is recidivism. Strong models will have a peak closer to 0 for the negatives (no recidivism), and a peak closer to 1 for the positives (recidivism). In the following graph we can see that our model is better at prediciting the positives rather than the negatives.

```{r}
testProbs <- data.frame(Outcome = as.factor(gentrifydataTest $gentrification), Probs = predict(gentrifyModel, gentrifydataTest , type= "response"))
head(testProbs)
```




```{r}
ggplot(testProbs, aes(x = Probs, fill = as.factor(Outcome))) + 
  geom_density() +
  facet_grid(Outcome ~ .) +
  scale_fill_manual(values = palette2) + xlim(1, 0) +
  labs(x = "Gentrification", y = "Density of probabilities",
       title = "Distribution of predicted probabilities by observed outcome") + theme(strip.text.x = element_text(size = 18),
        legend.position = "none")
```
## Confusion matrix

```{r}
testProbs <- 
  testProbs %>%
  mutate(predOutcome  = as.factor(ifelse(testProbs$Probs > 0.5 , 1, 0)))

caret::confusionMatrix(testProbs$predOutcome, testProbs$Outcome, 
                       positive = "0")
```


## Cross Validation
```{r}


# Replace NA values in the 'gentrification' column with 0 (or another appropriate value)
gentrifydata$gentrification <- ifelse(is.na(gentrifydata$gentrification), 0, gentrifydata$gentrification)


customSummary <- function(data, lev = NULL, model = NULL) {
  # Assuming the positive class is labeled as 'True'
  prob <- ifelse(data[, "true"] >= 0.3, lev[2], lev[1])
  
  # Convert probabilities to factors with levels as per the actual outcomes
  prob <- factor(prob, levels = lev)
  
  # Calculate confusion matrix based metrics
  cm <- confusionMatrix(data = prob, reference = data$obs)
  
  # Return a list including metrics like Accuracy, Sensitivity (Recall), and Specificity
  out <- c(cm$overall['Accuracy'], cm$byClass['Sensitivity'], cm$byClass['Specificity'])
  names(out) <- c('Accuracy', 'Sensitivity', 'Specificity')
  out
}

# Set up trainControl with the custom summary function
ctrl <- trainControl(method = "cv", 
                     number = 100, 
                     classProbs = TRUE, 
                     summaryFunction = customSummary)

# Fit the model
cvFit <- train(gentrification ~ .,
               data = gentrifydata %>% 
                 select(gentrification, changeinpoverty,changeinbachelor, changeinwhite,pctBachelors20,houseprice,changein2544),
               method = "glm", 
               family = "binomial",
               metric = "Accuracy",  # Now using Accuracy or whichever metric you prefer
               trControl = ctrl)

# Print the fit model
print(cvFit)
```


The figure below plots the distribution of AUC, Sensitivity, and Specificity across the 100 folds. The tighter each distribution is to its mean, the more generalizable the model. Based on the result, our model generalizes well to ROC, sensitivity and specificity. To be more specific, our model generalizes well with respect to the rate it correctly predicts No_recidivism and recidivism. Our model is consistent in how it predicts the outcome,recidivism.



```{r}
dplyr::select(cvFit$resample, -Resample) %>%
  gather(metric, value) %>%
  left_join(gather(cvFit$results[2:4], metric, mean)) %>%
  ggplot(aes(value)) + 
    geom_histogram(bins=35, fill = "#6baed6") +
    facet_wrap(~metric) +
    geom_vline(aes(xintercept = mean), colour = "#08519c", linetype = 3, size = 1.5) +
    scale_x_continuous(limits = c(0, 1)) +
    labs(x="Goodness of Fit", y="Count", title="CV Goodness of Fit Metrics",
         subtitle = "Across-fold mean reprented as dotted lines")

```

# Validation on Chicago
```{r}
## New housing permit
chicagonewhousingpermit <- read.socrata("https://data.cityofchicago.org/resource/ydr8-5enu.json")
  
chicagonewhousingpermit <- chicagonewhousingpermit %>%
mutate(issue_datenu = as.Date(issue_date, format = "%Y-%m-%d"))

df_2010_to_2015 <- chicagonewhousingpermit  %>%
  filter(between(as.integer(format(issue_date, "%Y")), 2010, 2015))
df_2010_to_2015 <- df_2010_to_2015 %>%
  dplyr::select(issue_date,id,longitude,latitude)%>%
  na.omit() 
chicagohousingpermit_sf <- st_as_sf(df_2010_to_2015, coords = c("longitude", "latitude"), crs = 4326, agr = "constant")%>%
st_transform('ESRI:102271') 

```

```{r}

# Read and process Chicago boundary data
chicagoBoundary <- 
  st_read(file.path(root.dir, "/Chapter5/chicagoBoundary.geojson")) %>%  # Read Chicago boundary data
  st_transform('ESRI:102271')  # Transform coordinate reference system



# Grocerystore
chicagogrocerystore <- read.socrata("https://data.cityofchicago.org/resource/3e26-zek2.json")

chicagogrocerystore <- chicagogrocerystore %>%
  mutate(
    location.coordinates = as.character(location.coordinates),  # Convert to character if not already
    coords = sapply(location.coordinates, function(x) {
      # Remove 'c(' and ')' from the string, split by ', ', and convert to numeric
      str <- gsub("c\\(|\\)", "", x)
      as.numeric(strsplit(str, ", ")[[1]])
    }, simplify = FALSE)  # Ensure output is a list
  ) %>%
  na.omit()  # Remove rows with NA values possibly due to incorrect parsing

chicagogrocerystore <- chicagogrocerystore %>%
  mutate(
    lon = sapply(coords, function(x) x[1]),  # Extract first element as longitude
    lat = sapply(coords, function(x) x[2])   # Extract second element as latitude
  ) %>%
  select(-coords, -location.coordinates) 
# Convert to an sf object with proper coordinates
chicagogrocerystore_sf <- st_as_sf(chicagogrocerystore, coords = c("lon", "lat"), crs = 4326, agr = "constant")%>%
st_transform('ESRI:102271') 




## Restaurant
restaurantchicago <- read.socrata("https://data.cityofchicago.org/resource/5udb-dr6f.json")

restaurantchicago <- restaurantchicago %>%
  dplyr::select(Y = latitude, X = longitude) %>%
  na.omit() %>%
  st_as_sf(coords = c("X", "Y"), crs = 4326, agr = "constant") %>% # Transforming to the specified CRS
st_transform('ESRI:102271')


# Renaming and transforming the dataframe
schoolchicago <- read.socrata("https://data.cityofchicago.org/resource/95e9-uzwt.json")
schoolchicago <- schoolchicago %>%
  mutate(
    the_geom.coordinates = as.character(the_geom.coordinates),  # Convert to character if not already
    coords = sapply(the_geom.coordinates, function(x) {
      # Remove 'c(' and ')' from the string, split by ', ', and convert to numeric
      str <- gsub("c\\(|\\)", "", x)
      as.numeric(strsplit(str, ", ")[[1]])
    }, simplify = FALSE)  # Ensure output is a list
  ) %>%
  na.omit()  # Remove rows with NA values possibly due to incorrect parsing

schoolchicago <- schoolchicago %>%
  mutate(
    lon = sapply(coords, function(x) x[1]),  # Extract first element as longitude
    lat = sapply(coords, function(x) x[2])   # Extract second element as latitude
  ) %>%
  select(-coords, -the_geom.coordinates) 
# Convert to an sf object with proper coordinates
schoolchicago_sf <- st_as_sf(schoolchicago, coords = c("lon", "lat"), crs = 4326, agr = "constant")%>%
st_transform('ESRI:102271')
schoolchicago_sf <- schoolchicago_sf%>%
dplyr::select(geometry)



# Read the CSV file into an R data frame
#crime_data <- read.csv("C:/Users/jiahangl/OneDrive - PennO365/MUSA508/A4/crime2018.csv")
#crime_data <- crime_data %>%
  #filter(!is.na(Longitude) & !is.na(Latitude))
```



#Feature engineering for Chicago

```{r}

# Fetch the data for LA, LA County, CA,2015
acs_chi <- get_acs(
  geography = "tract",
  variables = variables,
  year = 2015,
  state = "17",
  county = "031",
  geometry = TRUE,
  survey = "acs5",
  output = "wide"
)%>%
st_transform('ESRI:102271')



# Fetch the data for LA, LA County, CA,2020
acs_chi20 <- get_acs(
  geography = "tract",
  variables = variables,
  year = 2020,
  state = "17",
  county = "031",
  geometry = TRUE,
  survey = "acs5",
  output = "wide"
)%>%
  st_transform('ESRI:102271')
vars <- load_variables(2020, "acs5", cache = TRUE)




# Assuming acs_la is already an sf object with proper geometry handling
acs_chi <- acs_chi %>%
  rename(
    totalPop = B01001_001E,
    male = B01001_002E,
    female = B01001_026E,
    age_18_24 = B01001_007E,
    age_25_44 = B01001_012E,
    age_45_64 = B01001_016E,
    age_65plus = B01001_020E,
    white = B02001_002E,
    popblack = B02001_003E,
    latino = B03001_003E,
    other_race = B02001_004E,
    income_less_20k = B19001_002E,
    income_20k_40k = B19001_003E,
    income_40k_60k = B19001_006E,
    income_60k_80k = B19001_008E,
    income_80k_100k = B19001_010E,
    income_more_100k = B19001_012E,
    migration_total = B07001_001E,
    migration_within_county = B07001_017E,
    migration_different_county_same_state = B07001_033E,
    migration_different_state = B07001_049E,
    migration_from_abroad = B07001_065E,
    edu_less_high_school = B15001_002E,
    edu_high_school_grad = B15001_003E,
    edu_some_college = B15001_005E,
    edu_bachelors = B15001_009E,
    edu_grad_professional = B15001_010E,
    total_housing_units = B25001_001E,
    total_poverty = B06012_002E,
    vacant_units = B25002_003E,
    white_houseOwner = B25006_002E,
    total_occupied_units = B25006_001E,
    median_HH_income = B19013_001E,
    houseprice = B25077_001E,
    rent = B25031_001E,
    travetimetowork = B08133_001E
  ) %>%
  select(-starts_with("B"),-GEOID,-NAME) %>%
  mutate(
    WhiteHOrate = white_houseOwner / total_occupied_units,
    pctBachelors = ifelse(totalPop > 0, (edu_bachelors + edu_grad_professional) / totalPop, 0),
    pctPoverty = ifelse(totalPop > 0, total_poverty / totalPop, 0),
    pctWhitePop = ifelse(totalPop > 0, white / totalPop, 0),
    pctLatinoPop = ifelse(totalPop > 0, latino / totalPop, 0),
    pctBlackPop = ifelse(totalPop > 0, popblack / totalPop, 0),
    pctMigration = ifelse(totalPop > 0, migration_total / totalPop, 0),
    pctForeignMig = ifelse(totalPop > 0, migration_from_abroad / totalPop, 0),
    landArea = st_area(geometry),  # Ensure this is the correct function for your spatial data
    popDensity = totalPop / as.numeric(landArea)
  )


acs_chi20 <- acs_chi20 %>%
  rename(totalPop20 = "B01001_001E",
  male20 = "B01001_002E",
  female20 = "B01001_026E",
  age_18_2420 = "B01001_007E",
  age_25_4420 = "B01001_012E",
  age_45_6420 = "B01001_016E",
  age_65plus20 = "B01001_020E",
  white20 = "B02001_002E",
  popblack20 = "B02001_003E",
  latino20 = "B03001_003E",
  other_race20 = "B02001_004E",
  income_less_20k20 = "B19001_002E",
  income_20k_40k20 = "B19001_003E",
  income_40k_60k20 = "B19001_006E",
  income_60k_80k20 = "B19001_008E",
  income_80k_100k20 = "B19001_010E",
  income_more_100k20 = "B19001_012E",
  migration_total20 = "B07001_001E",
  migration_within_county20 = "B07001_017E",
  migration_different_county_same_state20 = "B07001_033E",
  migration_different_state20 = "B07001_049E",
  migration_from_abroad20 = "B07001_065E",
  edu_less_high_school20 = "B15001_002E",
  edu_high_school_grad20 = "B15001_003E",
  edu_some_college20 = "B15001_005E",
  edu_bachelors20 = "B15001_009E",
  edu_grad_professional20 = "B15001_010E",
  total_housing_units20 = "B25001_001E",
  total_poverty20 = "B06012_002E",
  vacant_units20 = "B25002_003E",
  white_houseOwner20 = "B25006_002E",
  total_Ooccupied_Uunits20 = "B25006_001E",
  median_HH_income20 = "B19013_001E",
  houseprice20 = "B25077_001E",
  rent20="B25031_001E",
  travetimetowork20 = B08133_001E
)%>%
  dplyr::select(-starts_with("B")) %>% #-starts_with("B") awesome!
  mutate(WhiteHOrate20 = white_houseOwner20/total_Ooccupied_Uunits20,
         pctBachelors20 = ifelse(totalPop20 > 0, ((edu_bachelors20 + edu_grad_professional20) / totalPop20),0),
         pctPoverty20 = ifelse(totalPop20 > 0, total_poverty20 / totalPop20, 0),
         pctWhitePop20 = ifelse(totalPop20 > 0, white20 / totalPop20, 0),
         pctLatinoPop20 = ifelse(totalPop20 > 0, latino20 / totalPop20, 0),
         pctBlackPop20 = ifelse(totalPop20 > 0, popblack20 / totalPop20, 0),
         pctMigration20 = ifelse(totalPop20 > 0, migration_total20 / totalPop20, 0),
         pctForeignMig20 = ifelse(totalPop20 > 0, migration_from_abroad20 / totalPop20, 0),
         landArea20 = st_area(geometry), 
         popDensity20 = totalPop20 / as.numeric(landArea20))




# Drop Margin Columns from ACS
datachicago<-st_join(acs_chi,acs_chi20)
chicagoBoundary <- st_transform(chicagoBoundary, crs = st_crs(datachicago))
tractchicagoclipped <- st_intersection(datachicago, chicagoBoundary)
tractchicagogeography <- tractchicagoclipped%>%
  dplyr::select(GEOID, geometry)


# grocerystore
chicagogrocerystore_sf <- chicagogrocerystore_sf %>%
  st_join(tractchicagogeography, left = F)
chigrocerystorenumber <- chicagogrocerystore_sf %>%
  group_by(GEOID) %>%  # Replace TRACT_ID with the actual identifier field for tracts
  summarise(chigrocerycount = n())
  
chigrocerystorenumber <- chigrocerystorenumber
chigrocerystorenumber <- st_set_geometry(chigrocerystorenumber, NULL)

gentrifydatachi <- left_join(tractchicagogeography, chigrocerystorenumber)

# restaurant
restaurantchicago <- restaurantchicago %>%
  st_join(tractchicagogeography, left = F)
restaurantchicago  <- restaurantchicago  %>%
  group_by(GEOID) %>%  # Replace TRACT_ID with the actual identifier field for tracts
  summarise(chirestcount = n())
  
restaurantchicago  <- restaurantchicago 
restaurantchicago  <- st_set_geometry(restaurantchicago , NULL)

gentrifydatachi <- left_join(gentrifydatachi, restaurantchicago )


# school
schoolchicago_sf <- schoolchicago_sf %>%
  st_join(tractchicagogeography, left = F)
schoolchicago_sf  <- schoolchicago_sf  %>%
  group_by(GEOID) %>%  # Replace TRACT_ID with the actual identifier field for tracts
  summarise(schoolcount = n())
  
schoolchicago_sf  <- schoolchicago_sf
schoolchicago_sf  <- st_set_geometry(schoolchicago_sf, NULL)

gentrifydatachi <- left_join(gentrifydatachi, schoolchicago_sf)


```
```{r}
crime2015_chi <- 
    read.socrata("https://data.cityofchicago.org/Public-Safety/Crimes-2001-to-Present/ijzp-q8t2") %>% 
    filter(year == "2015")
    dplyr::select(-Date, -Updated.On) %>%
    mutate(x = gsub("[()]", "", Location)) %>%
    separate(x,into= c("Y","X"), sep=",") %>%
    mutate(X = as.numeric(X),Y = as.numeric(Y)) %>% 
    na.omit() %>%
    st_as_sf(coords = c("X", "Y"), crs = 4326, agr = "constant")%>%
    st_transform('ESRI:102271') %>%  
    distinct()
```

```{r}
crime2020_chi <- 
    read.socrata("https://data.cityofchicago.org/Public-Safety/Crimes-2001-to-Present/ijzp-q8t2") %>% 
    filter(year == "2020")
    dplyr::select(-Date, -Updated.On) %>%
    mutate(x = gsub("[()]", "", Location)) %>%
    separate(x,into= c("Y","X"), sep=",") %>%
    mutate(X = as.numeric(X),Y = as.numeric(Y)) %>% 
    na.omit() %>%
    st_as_sf(coords = c("X", "Y"), crs = 4326, agr = "constant")%>%
    st_transform('ESRI:102271') %>% 
    distinct()
```
























```


# Conclusion










