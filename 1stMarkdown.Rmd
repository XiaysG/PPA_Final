---
title: "Measuring Gentrification - A Study in Boston"
author: "Xiayuanshan Gao"
date: "2024-05-07"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    number_sections: yes
    theme: cosmo 
    highlight: tango    
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(sf)
library(spdep)
library(caret)
library(ckanr)
library(FNN)
library(grid)
library(gridExtra)
library(ggcorrplot) # plot correlation plot
library(corrr)      # another way to plot correlation plot
library(kableExtra)
library(jtools)     # for regression model plots
library(ggstance) # to support jtools plots
library(ggpubr)    # plotting R^2 value on ggplot point scatter
library(broom.mixed) # needed for effects plots
library(RColorBrewer)
library(RSocrata)

library(RSocrata)
library(viridis)
library(spatstat)
library(spdep)
library(FNN)
library(knitr)
library(kableExtra)
library(tidycensus)

root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

palette5 <- c("#7892B5","#8CB9C0","#91B5A9","#EDCA7F","#D98481")
palette4 <- c("#7892B5","#8CB9C0","#EDCA7F","#D98481")
palette2 <- c("#7892B5","#D98481")

```

# Intro


# Data Collection



## boundary

```{r load}

# Reading neighborhood boundaries GeoJSON from the raw GitHub URL and transforming CRS
boundary <- st_read("C:/Users/jiahangl/OneDrive - PennO365/MUSA508/PPA_Final/CityBoundaryofLosAngeles.geojson")%>%
st_transform('ESRI:102645')
```


## Spatial Data

```{r}
# Bike Share Station

```

```{r}

```

```{r}

```
## Grocery store
```{r}
grocerystore <- read.socrata("https://data.lacity.org/resource/g986-7yf9.json")

# Clean and process the data
grocerystore <- grocerystore %>%
  dplyr::select(location_1.latitude, location_1.longitude) %>%
  na.omit() %>%
  st_as_sf(coords = c("location_1.longitude", "location_1.latitude"), crs = 4326, agr = "constant")%>%
 st_transform('ESRI:102645')
```

## New housing permit
```{r}
# Read new housing permit data
newhousingpermit <- read.socrata("https://data.lacity.org/resource/5u9x-y4iz.json")

# Clean and process the data
newhousingpermit <- newhousingpermit %>%
  dplyr::select(Y = location_1.latitude, X = location_1.longitude) %>%
  na.omit()%>%
  st_as_sf(coords = c("X", "Y"), crs = 4326, agr = "constant")%>%
   st_transform('ESRI:102645')
```

## Restaurant
```{r}
restaurant <- read.socrata("https://data.lacity.org/resource/ieer-tbdq.json")

restaurant <- restaurant %>%
  dplyr::select(Y = location_1.latitude, X = location_1.longitude) %>%
  na.omit() %>%
  st_as_sf(coords = c("X", "Y"), crs = 4326, agr = "constant") %>% # Transforming to the specified CRS
st_transform('ESRI:102645')

```

## educationfacities
```{r}
educationfacilities <- 
 st_read("https://services.arcgis.com/RmCCgQtiZLDCtblq/arcgis/rest/services/Schools_Colleges_and_Universities/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson") 

educationfacilities <- educationfacilities %>%
dplyr::select(Y = latitude, X = longitude) %>%
  na.omit() %>%
  st_as_sf(coords = c("X", "Y"), crs = 4326, agr = "constant")%>%  # Transforming to the specified CRS
  st_transform('ESRI:102645')
```

```{r}
# income restricted housing by neighborhood

inc_restricted_housing_2022 <- read.csv("https://data.boston.gov/dataset/feddfe5a-df16-4c60-8a3c-640c4d5281cd/resource/bfdeffc7-ab5e-4e28-9561-d4e84c9674e4/download/income-restricted-housing-inventory-2022.csv", stringsAsFactors = FALSE)

inc_restricted_housing_2018 <- read.csv("https://data.boston.gov/dataset/feddfe5a-df16-4c60-8a3c-640c4d5281cd/resource/47d53d7c-25b7-40b4-9259-da1d15373be6/download/income-restricted-inventory-2018-all-income-restricted-projects.csv", stringsAsFactors = FALSE)

```


## Census Data 2015 and 2020

```{r}

census_api_key("f681592f0e7bc7e399e41102649c493ec7f7f574") 

variables <- c("B01001_001E",
  "B01001_002E",
  "B01001_026E",
   "B01001_007E",
  "B01001_012E",
   "B01001_016E",
 "B01001_020E","B02001_002E","B02001_003E", "B03001_003E", "B02001_004E", "B19001_002E","B19001_003E", "B19001_006E", "B19001_008E",
"B19001_010E", "B19001_012E","B07001_001E","B07001_017E","B07001_033E",
"B07001_049E",
"B07001_065E",
  "B15001_002E",
 "B15001_003E",
"B15001_005E",
"B15001_009E",
"B15001_010E",
   "B25001_001E",
  "B06012_002E",
  "B25002_003E",
"B25006_002E",
  "B25006_001E",
  "B19013_001E",
"B25077_001E",
"B25031_001",
"B08133_001"
)



# Fetch the data for LA, LA County, CA,2015
acs_la <- get_acs(
  geography = "tract",
  variables = variables,
  year = 2015,
  state = "06",
  county = "037",
  geometry = TRUE,
  survey = "acs5",
  output = "wide"
)%>%
st_transform('ESRI:102645')



# Fetch the data for LA, LA County, CA,2020
acs_la20 <- get_acs(
  geography = "tract",
  variables = variables,
  year = 2020,
  state = "06",
  county = "037",
  geometry = TRUE,
  survey = "acs5",
  output = "wide"
)%>%
  st_transform('ESRI:102645')
vars <- load_variables(2020, "acs5", cache = TRUE)

```


```{r}
# Load necessary libraries
library(dplyr)
library(sf)  # for spatial operations like st_area()

# Assuming acs_la is already an sf object with proper geometry handling
acs_la <- acs_la %>%
  rename(
    totalPop = B01001_001E,
    male = B01001_002E,
    female = B01001_026E,
    age_18_24 = B01001_007E,
    age_25_44 = B01001_012E,
    age_45_64 = B01001_016E,
    age_65plus = B01001_020E,
    white = B02001_002E,
    popblack = B02001_003E,
    latino = B03001_003E,
    other_race = B02001_004E,
    income_less_20k = B19001_002E,
    income_20k_40k = B19001_003E,
    income_40k_60k = B19001_006E,
    income_60k_80k = B19001_008E,
    income_80k_100k = B19001_010E,
    income_more_100k = B19001_012E,
    migration_total = B07001_001E,
    migration_within_county = B07001_017E,
    migration_different_county_same_state = B07001_033E,
    migration_different_state = B07001_049E,
    migration_from_abroad = B07001_065E,
    edu_less_high_school = B15001_002E,
    edu_high_school_grad = B15001_003E,
    edu_some_college = B15001_005E,
    edu_bachelors = B15001_009E,
    edu_grad_professional = B15001_010E,
    total_housing_units = B25001_001E,
    total_poverty = B06012_002E,
    vacant_units = B25002_003E,
    white_houseOwner = B25006_002E,
    total_occupied_units = B25006_001E,
    median_HH_income = B19013_001E,
    houseprice = B25077_001E,
    rent = B25031_001E,
    travetimetowork = B08133_001E
  ) %>%
  select(-starts_with("B"),-GEOID,-NAME) %>%
  mutate(
    WhiteHOrate = white_houseOwner / total_occupied_units,
    pctBachelors = ifelse(totalPop > 0, (edu_bachelors + edu_grad_professional) / totalPop, 0),
    pctPoverty = ifelse(totalPop > 0, total_poverty / totalPop, 0),
    pctWhitePop = ifelse(totalPop > 0, white / totalPop, 0),
    pctLatinoPop = ifelse(totalPop > 0, latino / totalPop, 0),
    pctBlackPop = ifelse(totalPop > 0, popblack / totalPop, 0),
    pctMigration = ifelse(totalPop > 0, migration_total / totalPop, 0),
    pctForeignMig = ifelse(totalPop > 0, migration_from_abroad / totalPop, 0),
    landArea = st_area(geometry),  # Ensure this is the correct function for your spatial data
    popDensity = totalPop / as.numeric(landArea)
  )

```

```{r}
acs_la20 <- acs_la20 %>%
  rename(totalPop20 = "B01001_001E",
  male20 = "B01001_002E",
  female20 = "B01001_026E",
  age_18_2420 = "B01001_007E",
  age_25_4420 = "B01001_012E",
  age_45_6420 = "B01001_016E",
  age_65plus20 = "B01001_020E",
  white20 = "B02001_002E",
  popblack20 = "B02001_003E",
  latino20 = "B03001_003E",
  other_race20 = "B02001_004E",
  income_less_20k20 = "B19001_002E",
  income_20k_40k20 = "B19001_003E",
  income_40k_60k20 = "B19001_006E",
  income_60k_80k20 = "B19001_008E",
  income_80k_100k20 = "B19001_010E",
  income_more_100k20 = "B19001_012E",
  migration_total20 = "B07001_001E",
  migration_within_county20 = "B07001_017E",
  migration_different_county_same_state20 = "B07001_033E",
  migration_different_state20 = "B07001_049E",
  migration_from_abroad20 = "B07001_065E",
  edu_less_high_school20 = "B15001_002E",
  edu_high_school_grad20 = "B15001_003E",
  edu_some_college20 = "B15001_005E",
  edu_bachelors20 = "B15001_009E",
  edu_grad_professional20 = "B15001_010E",
  total_housing_units20 = "B25001_001E",
  total_poverty20 = "B06012_002E",
  vacant_units20 = "B25002_003E",
  white_houseOwner20 = "B25006_002E",
  total_Ooccupied_Uunits20 = "B25006_001E",
  median_HH_income20 = "B19013_001E",
  houseprice20 = "B25077_001E",
  rent20="B25031_001E",
  travetimetowork20 = B08133_001E
)%>%
  dplyr::select(-starts_with("B")) %>% #-starts_with("B") awesome!
  mutate(WhiteHOrate20 = white_houseOwner20/total_Ooccupied_Uunits20,
         pctBachelors20 = ifelse(totalPop20 > 0, ((edu_bachelors20 + edu_grad_professional20) / totalPop20),0),
         pctPoverty20 = ifelse(totalPop20 > 0, total_poverty20 / totalPop20, 0),
         pctWhitePop20 = ifelse(totalPop20 > 0, white20 / totalPop20, 0),
         pctLatinoPop20 = ifelse(totalPop20 > 0, latino20 / totalPop20, 0),
         pctBlackPop20 = ifelse(totalPop20 > 0, popblack20 / totalPop20, 0),
         pctMigration20 = ifelse(totalPop20 > 0, migration_total20 / totalPop20, 0),
         pctForeignMig20 = ifelse(totalPop20 > 0, migration_from_abroad20 / totalPop20, 0),
         landArea20 = st_area(geometry), 
         popDensity20 = totalPop20 / as.numeric(landArea20))
```

```{r}
# Drop Margin Columns from ACS
data<-st_join(acs_la,acs_la20)
boundary <- st_transform(boundary, crs = st_crs(data))
tractclipped <- st_intersection(data, boundary)
tractgeography <- tractclipped %>%
  dplyr::select(GEOID, geometry)
```




# Measuring Gentrification


## 


# Logistic regression


## Feature Engineering

## identify change in census
```{r}
# get stations in Brooklyn tracts
tractclipped  <- tractclipped  %>%
  mutate(changeinpoverty = pctPoverty20 - pctPoverty,
         changeinbachelor = pctBachelors20 - pctBachelors,
         changeinwhite = pctWhitePop20 - pctWhitePop)
```





## identify number of grocery stores in each tract
```{r}
# get stations in Brooklyn tracts
grocerystorepoint <- grocerystore %>%
  st_join(tractgeography, left = F)
grocerystorenumber <- grocerystorepoint %>%
  group_by(GEOID) %>%  # Replace TRACT_ID with the actual identifier field for tracts
  summarise(grocerycount = n())
  
grocerystorenumber <- grocerystorenumber
grocerystorenumber <- st_set_geometry(grocerystorenumber, NULL)

gentrifydata <- left_join(tractclipped, grocerystorenumber )
```
## identify number of new housing permit in each tract
```{r}
# get stations in Brooklyn tracts
newhousingpermitpoint <- newhousingpermit %>%
  st_join(tractgeography, left = F)
newhousingpermitnumber <- newhousingpermitpoint %>%
  group_by(GEOID) %>%  # Replace TRACT_ID with the actual identifier field for tracts
  summarise(newhousingpermitcount = n())
  
newhousingpermitnumber <- newhousingpermitnumber
newhousingpermitnumber <- st_set_geometry(newhousingpermitnumber, NULL)

gentrifydata <- left_join(gentrifydata, newhousingpermitnumber )
```
## identify number of restaurants in each tract
```{r}
# get stations in Brooklyn tracts
restaurantpoint <- restaurant %>%
  st_join(tractgeography, left = F)
restaurantnumber <- restaurantpoint %>%
  group_by(GEOID) %>%  # Replace TRACT_ID with the actual identifier field for tracts
  summarise(restaurantcount = n())
  
restaurantnumber <- restaurantnumber
restaurantnumber <- st_set_geometry(restaurantnumber, NULL)

gentrifydata <- left_join(gentrifydata, restaurantnumber )

```

## identify number of education facilities in each tract
```{r}
# get stations in Brooklyn tracts
educationfacilitiespoint <- educationfacilities %>%
  st_join(tractgeography, left = F)
educationfacilitiesnumber <- educationfacilitiespoint %>%
  group_by(GEOID) %>%  # Replace TRACT_ID with the actual identifier field for tracts
  summarise(educationfacilitiescount = n())
  
educationfacilitiesnumber <- educationfacilitiesnumber
educationfacilitiesnumber <- st_set_geometry(educationfacilitiesnumber, NULL)

gentrifydata <- left_join(gentrifydata, educationfacilitiesnumber )

```
## Visualizing amenity patterns
```{r}
library(ggplot2)
library(patchwork)


plot_school <- ggplot() +
  geom_sf(data=gentrifydata,fill="transparent", color = "grey")+
  stat_density2d(data = data.frame(st_coordinates(educationfacilitiespoint)), 
                 aes(X, Y, fill = ..level.., alpha = ..level..),
                 size = 0.01, bins = 40, geom = 'polygon') +
  scale_fill_gradient(low='#7892B5', high='#fecc5c', name = "Density") +
  scale_alpha(range = c(0.00, 0.35), guide = FALSE) +
  labs(title="Density of education facilities")+
   theme_void()



plot_grocerystores <- ggplot() +
  geom_sf(data=gentrifydata,fill="transparent", color = "grey")+
  stat_density2d(data = data.frame(st_coordinates(grocerystorepoint)), 
                 aes(X, Y, fill = ..level.., alpha = ..level..),
                 size = 0.01, bins = 40, geom = 'polygon') +
  scale_fill_gradient(low='#7892B5', high='#fecc5c', name = "Density") +
  scale_alpha(range = c(0.00, 0.35), guide = FALSE) +
  labs(title="Density of Grocery Stores")+
   theme_void()



plot_housingpermit <- ggplot() +
  geom_sf(data=gentrifydata,fill="transparent", color = "grey")+
  stat_density2d(data = data.frame(st_coordinates(newhousingpermitpoint)), 
                 aes(X, Y, fill = ..level.., alpha = ..level..),
                 size = 0.01, bins = 40, geom = 'polygon') +
  scale_fill_gradient(low='#7892B5', high='#fecc5c', name = "Density") +
  scale_alpha(range = c(0.00, 0.35), guide = FALSE) +
  labs(title="Density of housingpermit",subtitle = "Los Angelas,CA")+
   theme_void()




plot_restaurant<- ggplot() +
  geom_sf(data=gentrifydata,fill="transparent", color = "grey")+
  stat_density2d(data = data.frame(st_coordinates(restaurantpoint)), 
                 aes(X, Y, fill = ..level.., alpha = ..level..),
                 size = 0.01, bins = 40, geom = 'polygon') +
  scale_fill_gradient(low='#7892B5', high='#fecc5c', name = "Density") +
  scale_alpha(range = c(0.00, 0.35), guide = FALSE) +
  labs(title="Density of Restaurants",subtitle = "Los Angelas, CA")+
   theme_void()


wrap_plots(
  plot_restaurant, plot_school, plot_housingpermit, plot_grocerystores,
  ncol = 2  
)



```


## Modeling building

```{r}
set.seed(479)
trainIndex <- createDataPartition(y = paste(recidivism$race) , p = .65,
                                  list = FALSE,
                                  times = 1)
```



```{r}
recidivismTrain <- recidivism[ trainIndex,]
recidivismTest  <- recidivism[-trainIndex,]

recidivismModel <- glm(recidivism_within_3years_numeric ~ .,
                  data=recidivismTrain %>% 
                    dplyr::select(recidivism_within_3years_numeric,gender,race,age_at_release,dependents, supervision_level_first,education_level,prison_years,prison_offense,violations,supervision_risk_score_first, percent_days_employed,jobs_per_year,drugtests_thc_positive,drugtests_cocaine_positive, drugtests_meth_positive,gang_affiliated,prior_arrest_episodes_felony,prior_arrest_episodes_misd,prior_arrest_episodes_property,prior_conviction_episodes_6,prior_conviction_episodes_5,prior_conviction_episodes_4,prior_conviction_episodes_3,prior_conviction_episodes_2,prior_conviction_episodes_1,prior_revocations_probation,prior_revocations_parole,delinquency_reports,residence_changes,violations_instruction), family="binomial" (link="logit"))

# Load necessary libraries
library(dplyr)
library(knitr)
library(kableExtra)

# Assuming recidivismModel and previous steps have been correctly run
recidivism_sum <- summary(recidivismModel)
coefficients_table <- as.data.frame(recidivism_sum$coefficients)

# Apply significance stars based on p-values
coefficients_table$significance <- ifelse(coefficients_table$`Pr(>|z|)` < 0.001, '***',
                                         ifelse(coefficients_table$`Pr(>|z|)` < 0.01, '**',
                                                ifelse(coefficients_table$`Pr(>|z|)` < 0.05, '*',
                                                       ifelse(coefficients_table$`Pr(>|z|)` < 0.1, '.', ''))))



# Print the table with formatting
kable(coefficients_table %>% select(-significance, -`Pr(>|z|)`), align = "r") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  footnote(general_title = "\n", general = "Table 3")

```

```{r}
#OR <- exp(coefficients(recidivismModel)) #odds ratio (exponentiated coefficients)
#OR
```

Visually we now can begin comparing the predictions of recidivism. A negative or 0 value means that there is no recidivism, while a positive or 1 value means that there is recidivism. Strong models will have a peak closer to 0 for the negatives (no recidivism), and a peak closer to 1 for the positives (recidivism). In the following graph we can see that our model is better at prediciting the positives rather than the negatives.

```{r}
testProbs <- data.frame(Outcome = as.factor(recidivismTest$recidivism_within_3years_numeric), Probs = predict(recidivismModel, recidivismTest, type= "response"))
head(testProbs)
```




```{r}
ggplot(testProbs, aes(x = Probs, fill = as.factor(Outcome))) + 
  geom_density() +
  facet_grid(Outcome ~ .) +
  scale_fill_manual(values = palette2) + xlim(1, 0) +
  labs(x = "Recidivism", y = "Density of probabilities",
       title = "Distribution of predicted probabilities by observed outcome") + theme(strip.text.x = element_text(size = 18),
        legend.position = "none")
```


## Cross Validation
```{r}
customSummary <- function(data, lev = NULL, model = NULL) {
  # Assuming the positive class is labeled as 'True'
  prob <- ifelse(data[, "true"] >= 0.3, lev[2], lev[1])
  
  # Convert probabilities to factors with levels as per the actual outcomes
  prob <- factor(prob, levels = lev)
  
  # Calculate confusion matrix based metrics
  cm <- confusionMatrix(data = prob, reference = data$obs)
  
  # Return a list including metrics like Accuracy, Sensitivity (Recall), and Specificity
  out <- c(cm$overall['Accuracy'], cm$byClass['Sensitivity'], cm$byClass['Specificity'])
  names(out) <- c('Accuracy', 'Sensitivity', 'Specificity')
  out
}

# Set up trainControl with the custom summary function
ctrl <- trainControl(method = "cv", 
                     number = 100, 
                     classProbs = TRUE, 
                     summaryFunction = customSummary)

# Fit the model
cvFit <- train(recidivism_within_3years ~ .,
               data = recidivism %>% 
                 select(recidivism_within_3years, gender, race, age_at_release, dependents, supervision_level_first, education_level, prison_years, prison_offense, violations, supervision_risk_score_first, percent_days_employed, jobs_per_year, drugtests_thc_positive, drugtests_cocaine_positive, drugtests_meth_positive, gang_affiliated, prior_arrest_episodes_felony, prior_arrest_episodes_misd, prior_arrest_episodes_property, prior_conviction_episodes_6, prior_conviction_episodes_5, prior_conviction_episodes_4, prior_conviction_episodes_3, prior_conviction_episodes_2, prior_conviction_episodes_1, prior_revocations_probation, prior_revocations_parole, delinquency_reports, residence_changes, violations_instruction),
               method = "glm", 
               family = "binomial",
               metric = "Accuracy",  # Now using Accuracy or whichever metric you prefer
               trControl = ctrl)

# Print the fit model
print(cvFit)
```


The figure below plots the distribution of AUC, Sensitivity, and Specificity across the 100 folds. The tighter each distribution is to its mean, the more generalizable the model. Based on the result, our model generalizes well to ROC, sensitivity and specificity. To be more specific, our model generalizes well with respect to the rate it correctly predicts No_recidivism and recidivism. Our model is consistent in how it predicts the outcome,recidivism.



```{r}
dplyr::select(cvFit$resample, -Resample) %>%
  gather(metric, value) %>%
  left_join(gather(cvFit$results[2:4], metric, mean)) %>%
  ggplot(aes(value)) + 
    geom_histogram(bins=35, fill = "#6baed6") +
    facet_wrap(~metric) +
    geom_vline(aes(xintercept = mean), colour = "#08519c", linetype = 3, size = 1.5) +
    scale_x_continuous(limits = c(0, 1)) +
    labs(x="Goodness of Fit", y="Count", title="CV Goodness of Fit Metrics",
         subtitle = "Across-fold mean reprented as dotted lines")

```

# Validation on Chicago
```{r}
## New housing permit
chicagonewhousingpermit <- read.socrata("https://data.cityofchicago.org/resource/ydr8-5enu.json")
  
chicagonewhousingpermit <- chicagonewhousingpermit %>%
mutate(issue_datenu = as.Date(issue_date, format = "%Y-%m-%d"))

df_2010_to_2015 <- chicagonewhousingpermit  %>%
  filter(between(as.integer(format(issue_date, "%Y")), 2010, 2015))
df_2010_to_2015 <- df_2010_to_2015 %>%
  dplyr::select(issue_date,id,longitude,latitude)%>%
  na.omit() 
chicagohousingpermit_sf <- st_as_sf(df_2010_to_2015, coords = c("longitude", "latitude"), crs = 4326, agr = "constant")%>%
st_transform('ESRI:102271') 

```

```{r}

# Read and process Chicago boundary data
chicagoBoundary <- 
  st_read(file.path(root.dir, "/Chapter5/chicagoBoundary.geojson")) %>%  # Read Chicago boundary data
  st_transform('ESRI:102271')  # Transform coordinate reference system



# Grocerystore
chicagogrocerystore <- read.socrata("https://data.cityofchicago.org/resource/3e26-zek2.json")

chicagogrocerystore <- chicagogrocerystore %>%
  mutate(
    location.coordinates = as.character(location.coordinates),  # Convert to character if not already
    coords = sapply(location.coordinates, function(x) {
      # Remove 'c(' and ')' from the string, split by ', ', and convert to numeric
      str <- gsub("c\\(|\\)", "", x)
      as.numeric(strsplit(str, ", ")[[1]])
    }, simplify = FALSE)  # Ensure output is a list
  ) %>%
  na.omit()  # Remove rows with NA values possibly due to incorrect parsing

chicagogrocerystore <- chicagogrocerystore %>%
  mutate(
    lon = sapply(coords, function(x) x[1]),  # Extract first element as longitude
    lat = sapply(coords, function(x) x[2])   # Extract second element as latitude
  ) %>%
  select(-coords, -location.coordinates) 
# Convert to an sf object with proper coordinates
chicagogrocerystore_sf <- st_as_sf(chicagogrocerystore, coords = c("lon", "lat"), crs = 4326, agr = "constant")%>%
st_transform('ESRI:102271') 




## Restaurant
restaurantchicago <- read.socrata("https://data.cityofchicago.org/resource/5udb-dr6f.json")

restaurantchicago <- restaurantchicago %>%
  dplyr::select(Y = latitude, X = longitude) %>%
  na.omit() %>%
  st_as_sf(coords = c("X", "Y"), crs = 4326, agr = "constant") %>% # Transforming to the specified CRS
st_transform('ESRI:102271')


# Renaming and transforming the dataframe
schoolchicago <- read.socrata("https://data.cityofchicago.org/resource/95e9-uzwt.json")
schoolchicago <- schoolchicago %>%
  mutate(
    the_geom.coordinates = as.character(the_geom.coordinates),  # Convert to character if not already
    coords = sapply(the_geom.coordinates, function(x) {
      # Remove 'c(' and ')' from the string, split by ', ', and convert to numeric
      str <- gsub("c\\(|\\)", "", x)
      as.numeric(strsplit(str, ", ")[[1]])
    }, simplify = FALSE)  # Ensure output is a list
  ) %>%
  na.omit()  # Remove rows with NA values possibly due to incorrect parsing

schoolchicago <- schoolchicago %>%
  mutate(
    lon = sapply(coords, function(x) x[1]),  # Extract first element as longitude
    lat = sapply(coords, function(x) x[2])   # Extract second element as latitude
  ) %>%
  select(-coords, -the_geom.coordinates) 
# Convert to an sf object with proper coordinates
schoolchicago_sf <- st_as_sf(schoolchicago, coords = c("lon", "lat"), crs = 4326, agr = "constant")%>%
st_transform('ESRI:102271')
schoolchicago_sf <- schoolchicago_sf%>%
dplyr::select(geometry)



# Read the CSV file into an R data frame
#crime_data <- read.csv("C:/Users/jiahangl/OneDrive - PennO365/MUSA508/A4/crime2018.csv")
#crime_data <- crime_data %>%
  #filter(!is.na(Longitude) & !is.na(Latitude))
```



#Feature engineering for Chicago

```{r}

# Fetch the data for LA, LA County, CA,2015
acs_chi <- get_acs(
  geography = "tract",
  variables = variables,
  year = 2015,
  state = "17",
  county = "031",
  geometry = TRUE,
  survey = "acs5",
  output = "wide"
)%>%
st_transform('ESRI:102271')



# Fetch the data for LA, LA County, CA,2020
acs_chi20 <- get_acs(
  geography = "tract",
  variables = variables,
  year = 2020,
  state = "17",
  county = "031",
  geometry = TRUE,
  survey = "acs5",
  output = "wide"
)%>%
  st_transform('ESRI:102271')
vars <- load_variables(2020, "acs5", cache = TRUE)




# Assuming acs_la is already an sf object with proper geometry handling
acs_chi <- acs_chi %>%
  rename(
    totalPop = B01001_001E,
    male = B01001_002E,
    female = B01001_026E,
    age_18_24 = B01001_007E,
    age_25_44 = B01001_012E,
    age_45_64 = B01001_016E,
    age_65plus = B01001_020E,
    white = B02001_002E,
    popblack = B02001_003E,
    latino = B03001_003E,
    other_race = B02001_004E,
    income_less_20k = B19001_002E,
    income_20k_40k = B19001_003E,
    income_40k_60k = B19001_006E,
    income_60k_80k = B19001_008E,
    income_80k_100k = B19001_010E,
    income_more_100k = B19001_012E,
    migration_total = B07001_001E,
    migration_within_county = B07001_017E,
    migration_different_county_same_state = B07001_033E,
    migration_different_state = B07001_049E,
    migration_from_abroad = B07001_065E,
    edu_less_high_school = B15001_002E,
    edu_high_school_grad = B15001_003E,
    edu_some_college = B15001_005E,
    edu_bachelors = B15001_009E,
    edu_grad_professional = B15001_010E,
    total_housing_units = B25001_001E,
    total_poverty = B06012_002E,
    vacant_units = B25002_003E,
    white_houseOwner = B25006_002E,
    total_occupied_units = B25006_001E,
    median_HH_income = B19013_001E,
    houseprice = B25077_001E,
    rent = B25031_001E,
    travetimetowork = B08133_001E
  ) %>%
  select(-starts_with("B"),-GEOID,-NAME) %>%
  mutate(
    WhiteHOrate = white_houseOwner / total_occupied_units,
    pctBachelors = ifelse(totalPop > 0, (edu_bachelors + edu_grad_professional) / totalPop, 0),
    pctPoverty = ifelse(totalPop > 0, total_poverty / totalPop, 0),
    pctWhitePop = ifelse(totalPop > 0, white / totalPop, 0),
    pctLatinoPop = ifelse(totalPop > 0, latino / totalPop, 0),
    pctBlackPop = ifelse(totalPop > 0, popblack / totalPop, 0),
    pctMigration = ifelse(totalPop > 0, migration_total / totalPop, 0),
    pctForeignMig = ifelse(totalPop > 0, migration_from_abroad / totalPop, 0),
    landArea = st_area(geometry),  # Ensure this is the correct function for your spatial data
    popDensity = totalPop / as.numeric(landArea)
  )


acs_chi20 <- acs_chi20 %>%
  rename(totalPop20 = "B01001_001E",
  male20 = "B01001_002E",
  female20 = "B01001_026E",
  age_18_2420 = "B01001_007E",
  age_25_4420 = "B01001_012E",
  age_45_6420 = "B01001_016E",
  age_65plus20 = "B01001_020E",
  white20 = "B02001_002E",
  popblack20 = "B02001_003E",
  latino20 = "B03001_003E",
  other_race20 = "B02001_004E",
  income_less_20k20 = "B19001_002E",
  income_20k_40k20 = "B19001_003E",
  income_40k_60k20 = "B19001_006E",
  income_60k_80k20 = "B19001_008E",
  income_80k_100k20 = "B19001_010E",
  income_more_100k20 = "B19001_012E",
  migration_total20 = "B07001_001E",
  migration_within_county20 = "B07001_017E",
  migration_different_county_same_state20 = "B07001_033E",
  migration_different_state20 = "B07001_049E",
  migration_from_abroad20 = "B07001_065E",
  edu_less_high_school20 = "B15001_002E",
  edu_high_school_grad20 = "B15001_003E",
  edu_some_college20 = "B15001_005E",
  edu_bachelors20 = "B15001_009E",
  edu_grad_professional20 = "B15001_010E",
  total_housing_units20 = "B25001_001E",
  total_poverty20 = "B06012_002E",
  vacant_units20 = "B25002_003E",
  white_houseOwner20 = "B25006_002E",
  total_Ooccupied_Uunits20 = "B25006_001E",
  median_HH_income20 = "B19013_001E",
  houseprice20 = "B25077_001E",
  rent20="B25031_001E",
  travetimetowork20 = B08133_001E
)%>%
  dplyr::select(-starts_with("B")) %>% #-starts_with("B") awesome!
  mutate(WhiteHOrate20 = white_houseOwner20/total_Ooccupied_Uunits20,
         pctBachelors20 = ifelse(totalPop20 > 0, ((edu_bachelors20 + edu_grad_professional20) / totalPop20),0),
         pctPoverty20 = ifelse(totalPop20 > 0, total_poverty20 / totalPop20, 0),
         pctWhitePop20 = ifelse(totalPop20 > 0, white20 / totalPop20, 0),
         pctLatinoPop20 = ifelse(totalPop20 > 0, latino20 / totalPop20, 0),
         pctBlackPop20 = ifelse(totalPop20 > 0, popblack20 / totalPop20, 0),
         pctMigration20 = ifelse(totalPop20 > 0, migration_total20 / totalPop20, 0),
         pctForeignMig20 = ifelse(totalPop20 > 0, migration_from_abroad20 / totalPop20, 0),
         landArea20 = st_area(geometry), 
         popDensity20 = totalPop20 / as.numeric(landArea20))




# Drop Margin Columns from ACS
datachicago<-st_join(acs_chi,acs_chi20)
chicagoBoundary <- st_transform(chicagoBoundary, crs = st_crs(datachicago))
tractchicagoclipped <- st_intersection(datachicago, chicagoBoundary)
tractchicagogeography <- tractchicagoclipped%>%
  dplyr::select(GEOID, geometry)


# grocerystore
chicagogrocerystore_sf <- chicagogrocerystore_sf %>%
  st_join(tractchicagogeography, left = F)
chigrocerystorenumber <- chicagogrocerystore_sf %>%
  group_by(GEOID) %>%  # Replace TRACT_ID with the actual identifier field for tracts
  summarise(chigrocerycount = n())
  
chigrocerystorenumber <- chigrocerystorenumber
chigrocerystorenumber <- st_set_geometry(chigrocerystorenumber, NULL)

gentrifydatachi <- left_join(tractchicagogeography, chigrocerystorenumber)

# restaurant
restaurantchicago <- restaurantchicago %>%
  st_join(tractchicagogeography, left = F)
restaurantchicago  <- restaurantchicago  %>%
  group_by(GEOID) %>%  # Replace TRACT_ID with the actual identifier field for tracts
  summarise(chirestcount = n())
  
restaurantchicago  <- restaurantchicago 
restaurantchicago  <- st_set_geometry(restaurantchicago , NULL)

gentrifydatachi <- left_join(gentrifydatachi, restaurantchicago )


# school
schoolchicago_sf <- schoolchicago_sf %>%
  st_join(tractchicagogeography, left = F)
schoolchicago_sf  <- schoolchicago_sf  %>%
  group_by(GEOID) %>%  # Replace TRACT_ID with the actual identifier field for tracts
  summarise(schoolcount = n())
  
schoolchicago_sf  <- schoolchicago_sf
schoolchicago_sf  <- st_set_geometry(schoolchicago_sf, NULL)

gentrifydatachi <- left_join(gentrifydatachi, schoolchicago_sf)


```


```























```


# Conclusion










